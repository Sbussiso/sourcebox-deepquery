{% extends "base.html" %}

{% block title %}
    Chatbot
{% endblock %}

{% block content %}
<style>
    .chat-bubble {
        padding: 10px 15px;
        border-radius: 15px;
        margin-bottom: 10px;
        max-width: 75%;
    }
    .chat-bubble.user {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
    }
    .chat-bubble.bot {
        background-color: #e9ecef;
        color: black;
        align-self: flex-start;
    }
    .input-group {
        position: relative;
    }
    .input-group textarea {
        resize: none;
        overflow-y: auto;
        width: 100%;
        max-height: 200px; /* Limit the height of the textarea */
    }
    .card-body {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 400px); /* Adjust based on header and other content */
    }
    #messages {
        flex-grow: 1;
        overflow-y: auto;
    }
</style>

<div class="card w-75 mx-auto">
    <div class="card-header text-center">
        <h3>Chat with WikiBot</h3>
    </div>
    <div class="p-3">
        <button type="button" id="backHome" class="btn btn-danger">Back to Home</button>
    </div>
    <div class="p-3">
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
              Use Pack Data
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <li><a class="dropdown-item" href="#" onclick="selectPack('No Pack', '')">No Pack</a></li>
              {% if packs %}
                {% for pack in packs %}
                  <li><a class="dropdown-item" href="#" onclick="selectPack('{{ pack.pack_name }}', '{{ pack.id }}')">{{ pack.pack_name }}</a></li>
                {% endfor %}
              {% else %}
                <li><a class="dropdown-item" href="#">No packs available</a></li>
              {% endif %}
            </ul>
        </div>
        <br/>
        <p id="selectedPack">No pack data being referenced :(</p>
    </div>
    <div class="p-3" id="delHistory" align="right"><button type="button" class="btn btn-danger">Delete History</button></div>
    <div class="card-body d-flex flex-column">
        <div id="messages" class="d-flex flex-column border p-3 mb-3" style="height: 100%; overflow-y: auto;"></div>
        <div class="input-group">
            <textarea id="message" class="form-control" placeholder="Type a message" rows="1" required></textarea>
            <button class="btn btn-primary input-group-text" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
    let selectedPackId = null;
    let conversationHistory = [];

    const messageTextarea = document.getElementById("message");

    messageTextarea.addEventListener("input", function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    messageTextarea.addEventListener("keypress", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        if (selectedPackId === null) {
            alert("Please select an option from the dropdown. Select 'No Pack' if you do not wish to use any pack data.");
            return;
        }

        const message = messageTextarea.value;
        if (message.trim()) {
            appendMessage("User", message, "user");
            conversationHistory.push({ sender: "user", message: message });

            const payload = {
                message: message,
                history: conversationHistory
            };

            if (selectedPackId) {
                payload.pack_id = selectedPackId;
            }

            fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                appendMessage("Bot", data.response, "bot");
                conversationHistory.push({ sender: "bot", message: data.response });
                messageTextarea.value = '';
                messageTextarea.style.height = 'auto';
                document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
            })
            .catch(error => console.error("Error:", error));
        }
    }

    function appendMessage(sender, message, type) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("chat-bubble", type);
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        document.getElementById("messages").appendChild(messageDiv);
    }

    function selectPack(packName, packId) {
        selectedPackId = packId;
        document.getElementById('selectedPack').innerText = `Selected Pack: ${packName}`;
    }

    //delete history button logic
    const delButton = document.getElementById('delHistory');

    delButton.addEventListener('click', function() {
        conversationHistory = [];
        document.getElementById('messages').innerHTML = '';
        alert('Conversation History Deleted');
    });

    //back to home button logic
    document.getElementById('backHome').addEventListener('click', function() {
        window.location.href = 'https://sourcebox-official-website-9f3f8ae82f0b.herokuapp.com/'; //sourcebox home page
    });
</script>
{% endblock %}
